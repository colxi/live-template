import"./log.js";import{Config,ConfigInterface}from"./core-config.js";import{Observer}from"./core-observer.js";import{Keypath}from"./core-keypath.js";import{Bind}from"./core-bind.js";import{Unbind}from"./core-unbind.js";import{Util}from"./core-util.js";import{Bindings}from"./core-bindings.js";import{Subscribe}from"./core-subscribe.js";import{Debug}from"./debugger/debugger.js";import{Expression}from"./core-expression.js";Keypath.defaultContext(Observer._enumerate_());let _DOM_OBSERVER_=new MutationObserver(e=>{for(let t of e)"childList"===t.type&&(console.log(t.removedNodes),Array.from(t.removedNodes).forEach(Unbind.element),t.addedNodes.forEach(Bind.element),Debug.loadTab())});const Template=window.Template=function(e){};Template.create=function(e){if("string"==typeof e&&(e=document.querySelectorAll(e)[0]),void 0===e)e=document.documentElement;else if(!(e instanceof HTMLElement))throw new Error("Template.bind(): Invalid input");if(Bindings.templates.has(e)||Util.getParents(e).filter(e=>Bindings.templates.has(e)).length)return console.log("An existing template is already using this element"),!1;const t=e.innerHTML,o=[];return Array.from(e.attributes).forEach(e=>{o.push({name:e.name,value:e.value})}),console.log("Creating Template",e),Bind.element(e),_DOM_OBSERVER_.observe(e,{attributes:!1,childList:!0,subtree:!0,characterData:!1}),Bindings.templates.set(e,{content:t,attributes:o,observer:null,id:null}),console.log("Template Complete"),Debug.loadTab(),!0},Template.destroy=function(e){if("string"==typeof e&&(e=document.querySelectorAll(e)[0]),void 0===e)e=document.documentElement;else if(!(e instanceof HTMLElement))throw new Error("Template.bind(): Invalid input");if(!Bindings.templates.has(e))return console.log("This Element is not the root of any Template."),!1;console.log("Destroying Template",e);const t=Bindings.templates.get(e);return _DOM_OBSERVER_.disconnect(),Unbind.element(e),Array.from(e.attributes).forEach(t=>e.removeAttribute(t.name)),t.attributes.forEach(t=>e.setAttribute(t.name,t.value)),e.innerHTML=t.content,Bindings.templates.delete(e),console.log("Template Destroyed"),!0},Template.Model=function(e,t){if("string"!=typeof e||!e.length)throw new Error("Template.Model requires a name argument");if(void 0===t)return Observer(e);if(!(this instanceof Template.Model))throw new Error("Model Constructor must be called using 'new'.");return new Observer(t,Subscribe.dom,{id:e,observeConstruction:!0,ignoreSameValueReassign:!1})},Template.View=function(e,t){},Template.loadModel=function(e=""){if("string"!=typeof e)throw new Error("Template.loadModel() : Model name must be a String.");return e=e.trim(),e=Config.modelsPath+e,Config.modelsNamesExtension&&(e+=Config.modelsNamesExtension),new Promise((t,o)=>{let n=document.createElement("script"),r="__tempModuleLoadingVariable"+Math.random().toString(32).substring(2);window[r]=function(e){t(e),window[r]=null,delete window[r],n.remove(),n=null},n.onerror=(()=>{o(new Error("Template.loadModel() : Failed to load model script with URL "+e)),window[r]=null,delete window[r],n.remove(),n=null}),n.type="module",n.textContent=`import * as m from "${e}"; window.${r}( m.default )`,document.documentElement.appendChild(n)})},Template.loadView=function(e=""){if("string"!=typeof e)throw new Error("Template.loadView() : View name must be a String.");return new Promise(function(t,o){fetch(Config.viewsPath+e+Config.viewsNamesExtension).then(e=>{t(!0===e.ok&&e.text())})})},Object.defineProperty(Template,"Config",{set(e){if("object"!=typeof e)throw new Error("Config : Provided value must be an Object.");for(let t in e)e.hasOwnProperty(t)&&(this.Config[t]=e[t]);return!0},get:()=>ConfigInterface,enumerable:!0,configurable:!0});